# FDMM Kraken (name subject to change)

*WIP Node-Based Print Farm Management Docker Ecosystem*

![The FDMM Kraken Dashboard](https://raw.githubusercontent.com/AndrewSpangler/fdmm-kraken/refs/heads/main/docu/screenshot.png)

FDMM Kraken is a work in progress with a number of goals:
 - [x] Create standalone secure Docker based ecosystem to manage individual print farm nodes
 - [ ] Automate creation of secrets files using an entrypoint rather than using environment variables 
 - [ ] Create an extensible system with multiple nodes managed by a single control server
 - [ ] Enable node autodiscovery
 - [ ] Create an automatic dns system where the control server serves an aggregated record of node DNS names
 - [ ] Create a nested-node system where nodes can proxy control to other nodes
 - [ ] Create PXE Boot server system for fully automatic node deployment (will need external DHCP)
 - [ ] Provide examples of integrating with Proxy/DDNS services like Cloudflare


## Setup

### OS

**THE NAME OF YOUR HOST IS IMPORTANT**
IT WILL USED TO CONFIGURE LOCAL DNS / HANDLE PROXYING THIS GUIDE ASSUMES YOU NAMED YOUR COMPUTER `printhost`. IF YOU SET IT TO SOMETHING ELSE DURING UBUNTU / RASPI INSTALL YOU WILL NEED TO ADAPT THE FOLLOWING STEPS ACCORDINGLY.

 - This docker stack is a little heavy and has not been tested on a RasPi.
 - It may work on a higher-end RasPi, however if you find you are running into performance issues try removing some of the ancillary containers like Portainer / Filebrowser / Code-Server / Glances / unneeded printer service containers. Removing traefik, autheia, openldap, or coredns will break the reverse proxy / auth system.

 - This stack has been tested on a Ryzen 7 2700X using [Ubuntu Server 24.04.1 LTS](https://ubuntu.com/download/server). during installation Docker was selected to be installed and a user called "administrator" was created. SSH was enabled so the server could be configured headless. Configure a static IP address if you are able. 

### Install
 - This process assumes you are running Ubuntu Server 24.04.01, you may need to adjust it to work on a RasPi
 
#### Connect to Node
 - Connect to the node via SSH, if you are using Ubuntu Desktop you can skip this step and just open up a terminal. You will need to get the ip of the node from your router or the node itself if you have direct access. This will be something like `192.168.1.12`
 - Run `ssh administrator@192.168.1.12`, replace the ip with the one from your node.

#### Install Git
 - Enter the following commands to install git, git will be used to pull down / update Kraken in the future
```bash
sudo apt update
sudo apt install git -y
```

#### Make Kraken Folder and Pull Project
 - Use git to pull the project, the nnavigate into the directory the project was pulled into
```bash
git pull https://github.com/AndrewSpangler/fdmm-kraken.git
cd ./fdmm-kracken
```

#### Setup VS Code for Kraken Config
 - The easiest way to configure the Kraken environment is by using a temporary code-server container. Kraken includes a code-server container so this one can be deleted using portainer once you get the system running. Make sure you run this command in the fdmm-kraken directory.
 - Run the following command:
```bash
docker run -d \
  --name=temp-code-server \
  -e PUID=1000 \
  -e PGID=1000 \
  -e PASSWORD=password `CHANGEME` \
  -e DEFAULT_WORKSPACE=/workspace \
  -p 8443:8443 \
  -v ./config/temp-code-server:/config \
  -v ./:/workspace \
  --restart unless-stopped \
  lscr.io/linuxserver/code-server:latest
```
This will create a code-server instance for configuring fdmm-kraken
You can access the container by going to http://ip.ad.re.ss:8443 - for example if the node IP address is 192.168.1.12 you would visit https://192.168.1.12:8443

#### Configure Kraken Environment Variables
 - Once in code server you will see a list of files and folders on the left, this is your docker compose environment. Some files and folders will be generated after the first launch of the compose stack:
    - appdata
      - *Folder for data generated by containers*
    - certs
      - *Folder to holder server certificates*
    - config
      - *Folder to holder container config folders*
    - fdmmhydra
      - *Folder for locally built config application, fdmmhydra currently disabled*
    - logs
      - *Folder for some container logs*
    - .gitignore
      - *File for git repo management, used for updates*
    - docker-compose.yml
      - *Main Docker configuration file*
    - readme.md
      - *What you're currently reading*
    - rebuild_fdmmhydra.sh
      - *Development script, do not use unless building fdmmhydra yourself*
    - template.env *Template file, you will need to make a copy of this and name it `.env`*

 - Kraken will automatically generate the needed self-signed cert for Traefik reverse-proxying. This enables a secure connection to the server, however it also means the certificate is not trusted by most browsers. You will need to download and install the generated Root CA Certificate to your OS on your device (works on Windows / Mac / Linux). Having the node Reverse-proxying greatly simplifies access control, security, and routing to containers. 

 - Kraken is primarily configured though Docker environment variables using a `.env` file. Most of the configuration is host info, passwords, timezones, and ports. You MUST correctly set the DOMAINNAME variable or proxying and certifcate generation will not work right. If you misconfigure these you will need to down the entire compose stack, fix it, and re-run the stack.

  - Make a copy of the provided `template.env` file and rename it to `.env` and edit the fields marked with #CHANGEME, [it-tools](https://it-tools.tech/token-generator) can make deployment easier

#### Configure Openldap
After first launch you will need to set up openldap using the automated process from ldap-user-manager by going to http://ip.ad.re.ss:8785/setup - for example if the node IP address is 192.168.1.12 you would visit https://192.168.1.12:8785/setup
Follow the simple guided process to create all the needed groups and other objects for openldap authentication  
Once you've gone through the setup process and created the admin user move on to the next step.

#### Configure 

#### Advanced Config:
  - Todo:
    - Section on homepage
    - Section on klipper/moonraker/fluidd/mainsail
    - Section on ldap

## Credits:
 - Davidzwa, author of [FDM-Monster](https://github.com/fdm-monster/fdm-monster) for supporting this project and for writing FDM-Monster, without it this project wouldn't exist. I stole heavily from his color scheme for the dashboard / config application.
 - Klipper compose and config heavily inspired by [klipper-web-control-docker](https://github.com/dimalo/klipper-web-control-docker?tab=readme-ov-file#install-the-services)
 - Some mkcert configuration taken from [Setting Up Traefik and mkcert for Local Development](https://dev.to/agusrdz/setting-up-traefik-and-mkcert-for-local-development-48j5)

### Icons:
 - Unless noted, most homepage icons were originally sourced from [pictogrammers](https://pictogrammers.com/) and edited to match the FDMM theme.

 - Portainer, Fluidd, Klipper, VS Code, and Mainsail sourced from their respective projects and edited to match the FDMM theme.

 - FDM-Monster icon from FDM-Monster project.

 - FDM Kracken / Octoprint - me :)